
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finity - Local Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4361ee',
                        'secondary': '#3f37c9',
                        'success': '#4cc9f0',
                        'danger': '#f72585',
                        'warning': '#f8961e',
                        'dark': '#1d3557',
                        'light': '#f8f9fa',
                        'gray': '#6c757d',
                        // --- MODIFIED FOR PURE BLACK BACKGROUND ---
                        'dark-bg': '#000000', // Pure Black Background
                        'dark-card': '#111111', // Near-Black Card/Element Color
                        'dark-border': '#333333',
                    },
                    animation: {
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8f9fa; /* Default light background */
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-y: scroll;
        }

        /* ---------------------------------
            Improved Full Dark Mode Styles (FIXED for BLACK background)
            --------------------------------- */
        .dark-mode {
            background-color: var(--tw-colors-dark-bg) !important; /* #000000 */
            color: #e2e8f0;
        }
        
        /* Elements that are white in light mode become dark-card in dark mode */
        .dark-mode .bg-white { 
            background-color: var(--tw-colors-dark-card) !important; /* #111111 */
        }
        
        /* Input field background now uses dark-card or a similar dark shade from config, and ensures primary text is light. */
        .dark-mode input, 
        .dark-mode select, 
        .dark-mode textarea { 
            background-color: #222222 !important; /* Slightly darker than card for contrast */
            color: #e2e8f0 !important; 
            border-color: var(--tw-colors-dark-border) !important; 
        }
        
        /* Ensure elements that use the 'dark' utility color (like main headings) are light in dark mode */
        .dark-mode .text-dark { 
            color: #e2e8f0 !important; 
        }
        
        /* Fix for lighter text colors used in light mode */
        .dark-mode .text-gray-700 { 
            color: #a0aec0 !important; 
        }
        .dark-mode .text-gray-500,
        .dark-mode .text-gray-600 { 
            color: #9ca3af !important; 
        }

        /* Fix for light background elements */
        .dark-mode .bg-gray-50,
        .dark-mode .bg-light { /* Auth page right panel background */
            background-color: var(--tw-colors-dark-bg) !important; 
        }

        /* Fix for borders (like achievement list dividers, content separators) */
        .dark-mode .border-gray-200, 
        .dark-mode .border-b, 
        .dark-mode .border-l,
        .dark-mode .border-gray-100 { 
            border-color: var(--tw-colors-dark-border) !important; 
        }

        /* Specific elements */
        .dark-mode .message.bot-message { 
            background-color: var(--tw-colors-dark-card) !important; 
            color: #e2e8f0 !important; 
        }
        .dark-mode .expense-item { 
            background-color: #222222 !important; /* Match bg-gray-50 fix */
        }
        .dark-mode .nav-btn.text-gray-700 { 
            color: #a0aec0 !important; 
        }
        .dark-mode .nav-btn:hover { 
            background-color: #222222 !important; 
        }
        .dark-mode .chart-title { 
            color: #e2e8f0 !important; 
        }
        /* Auth page specific fixes */
        .dark-mode .bg-dark {
            background-color: var(--tw-colors-dark-card) !important; /* Footer BG becomes dark card */
        }

        /* General styles (Unchanged) */
        .loading {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .modal { background: rgba(0, 0, 0, 0.5); z-index: 50; }

        /* Notification Styling (Unchanged) */
        .notification-alert {
            position: fixed;
            top: 1rem;
            right: 1rem;
            min-width: 300px;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            z-index: 50;
        }
    </style>
</head>
<body class="p-0 md:p-0 transition-colors duration-300 min-h-screen flex flex-col" id="body">
    
    <div class="max-w-7xl mx-auto relative z-10 w-full flex-grow">
        <div id="notificationContainer" class="fixed top-4 right-4 space-y-3 z-50">
        </div>

        <div class="flex flex-col lg:flex-row min-h-screen w-full" id="authPage">
            
            <div class="lg:w-1/2 bg-primary text-white p-12 flex flex-col justify-center items-center relative overflow-hidden transition-colors duration-300">
                <div class="absolute inset-0 bg-gradient-to-br from-primary via-secondary to-blue-700 opacity-80 animate-pulse-slow"></div>
                
                <div class="relative z-10 text-center">
                    <i class="fas fa-wallet text-8xl mb-6 transform hover:scale-105 transition-transform duration-300"></i>
                    <h1 class="text-6xl font-extrabold mb-4">FINITY</h1>
                    <p class="text-xl font-light max-w-md mx-auto">Your AI-Powered Financial Navigator. Track, Analyze, and Achieve your money goals effortlessly.</p>
                </div>
                
                <div class="relative z-10 mt-10 p-4 border border-white/50 rounded-lg text-sm bg-white/10 backdrop-blur-sm">
                    "Finity keeps me in control of my future."
                </div>
            </div>

            <div class="lg:w-1/2 flex flex-col justify-center items-center p-8 md:p-12 bg-light transition-colors duration-300">
                <div class="w-full max-w-md">
                    <h2 class="text-4xl font-extrabold text-dark mb-2 transition-colors duration-300" id="authTitle">Login to Finity</h2>
                    <p class="text-gray-500 mb-8 transition-colors duration-300">Enter your credentials to manage your finance.</p>
                    
                    <div class="bg-white rounded-xl shadow-2xl p-8 transition-colors duration-300 border border-gray-100">
                        <form id="authForm">
                            <div class="mb-4">
                                <label for="authUsername" class="block text-gray-700 font-medium mb-2">Username</label>
                                <input type="text" id="authUsername" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition-colors duration-300" placeholder="Enter username" required>
                            </div>
                            <div class="mb-6">
                                <label for="authPassword" class="block text-gray-700 font-medium mb-2">Password</label>
                                <input type="password" id="authPassword" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition-colors duration-300" placeholder="Enter password" required>
                            </div>
                            <button type="submit" class="w-full bg-primary text-white p-3 rounded-lg font-semibold hover:bg-secondary transition duration-200 shadow-md hover:shadow-lg">
                                <span id="authBtnText">Login</span>
                            </button>
                        </form>
                        <div class="text-center mt-4">
                            <a href="#" id="toggleAuthMode" class="text-primary hover:underline text-sm font-medium">New User? Sign Up</a>
                        </div>
                    </div>
                </div>
                
                <div class="mt-8 text-center text-gray-400">
                    <p class="text-xs">
                        <i class="fas fa-copyright"></i> 2025 Finity Prototype
                    </p>
                </div>
            </div>
        </div>

        <div class="hidden" id="dashboardPage">
            <header class="bg-white p-4 md:p-6 rounded-xl shadow-lg mb-6 flex justify-between items-center transition-colors duration-300">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-wallet text-3xl text-primary"></i>
                    <h1 class="text-2xl font-bold text-dark transition-colors duration-300">Finity</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm font-semibold p-2 bg-success text-white rounded-full px-4" id="currentBalanceDisplay">
                        Balance: ₹0.00
                    </div>
                    <div class="text-sm font-semibold p-2 bg-primary text-white rounded-full px-4" id="totalSavedDisplay">
                        Saved: ₹0.00
                    </div>
                    <button id="addIncomeBtn" class="bg-primary text-white p-2 rounded-full hover:bg-secondary transition duration-200">
                        <i class="fas fa-plus text-xl"></i>
                    </button>
                    <button id="logoutBtn" class="text-gray-700 hover:text-danger p-2 rounded-full transition duration-200">
                        <i class="fas fa-sign-out-alt text-xl"></i>
                    </button>
                    <button id="toggleDarkMode" class="text-gray-700 hover:text-primary p-2 rounded-full transition duration-200">
                        <i class="fas fa-moon text-xl"></i>
                    </button>
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <nav class="lg:col-span-1 bg-white p-4 rounded-xl shadow-lg transition-colors duration-300 h-fit sticky top-6">
                    <h3 class="text-lg font-bold text-primary mb-4 pb-2 border-b border-gray-200">Menu</h3>
                    <ul class="space-y-2">
                        <li><button class="nav-btn w-full text-left p-3 rounded-lg flex items-center space-x-3 bg-primary text-white" data-target="dashContent"><i class="fas fa-chart-line"></i><span>Dashboard</span></button></li>
                        <li><button class="nav-btn w-full text-left p-3 rounded-lg flex items-center space-x-3 text-gray-700 hover:bg-gray-100" data-target="insightsContent"><i class="fas fa-chart-pie"></i><span>Insights</span></button></li>
                        <li><button class="nav-btn w-full text-left p-3 rounded-lg flex items-center space-x-3 text-gray-700 hover:bg-gray-100" data-target="achievementsContent"><i class="fas fa-trophy"></i><span>Achievements</span></button></li>
                        <li><button class="nav-btn w-full text-left p-3 rounded-lg flex items-center space-x-3 text-gray-700 hover:bg-gray-100" data-target="profileContent"><i class="fas fa-user"></i><span>Profile</span></button></li>
                    </ul>
                </nav>

                <main class="lg:col-span-3">
                    <div id="dashContent" class="content-panel space-y-6">
                        <h2 class="text-3xl font-bold text-dark transition-colors duration-300">Welcome, <span id="welcomeUsername">User</span>!</h2>
                        
                        <div class="bg-white p-6 rounded-xl shadow-lg transition-colors duration-300 border-l-4 border-primary">
                            <h3 class="text-xl font-bold text-primary mb-4 flex items-center space-x-2"><i class="fas fa-piggy-bank"></i><span>Manage Savings</span></h3>
                            
                            <form id="saveMoneyForm" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                                <input type="number" id="saveAmount" class="md:col-span-3 p-3 border border-gray-300 rounded-lg" placeholder="Amount to Save (₹)" min="0.01" step="0.01" required>
                                <button type="submit" class="md:col-span-1 bg-primary text-white p-3 rounded-lg font-semibold hover:bg-secondary transition duration-200 flex items-center justify-center space-x-2">
                                    <i class="fas fa-arrow-up"></i><span>Log Savings</span>
                                </button>
                                <p class="md:col-span-4 text-sm text-gray-500 mt-0">This moves money from your **Balance** to your **Saved** total.</p>
                            </form>
                            
                            <form id="withdrawMoneyForm" class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4 border-t pt-4 border-gray-200">
                                <input type="number" id="withdrawAmount" class="md:col-span-3 p-3 border border-gray-300 rounded-lg" placeholder="Amount to Withdraw (₹)" min="0.01" step="0.01" required>
                                <button type="submit" class="md:col-span-1 bg-danger text-white p-3 rounded-lg font-semibold hover:bg-danger/80 transition duration-200 flex items-center justify-center space-x-2">
                                    <i class="fas fa-arrow-down"></i><span>Withdraw</span>
                                </button>
                                <p class="md:col-span-4 text-sm text-gray-500 mt-0">This moves money from your **Saved** total back to your **Balance**.</p>
                            </form>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-lg transition-colors duration-300">
                            <h3 class="text-xl font-bold text-primary mb-4 flex items-center space-x-2"><i class="fas fa-plus-circle"></i><span>Add New Expense</span></h3>
                            <form id="expenseForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <input type="text" id="expenseDescription" class="md:col-span-2 p-3 border border-gray-300 rounded-lg" placeholder="Description (e.g., Coffee, Rent share)">
                                <input type="number" id="expenseAmount" class="p-3 border border-gray-300 rounded-lg" placeholder="Amount (₹)" min="0.01" step="0.01" required>
                                <select id="expenseCategory" class="p-3 border border-gray-300 rounded-lg" required>
                                    <option value="shopping">Shopping</option>
                                    <option value="food">Food</option>
                                    <option value="bills">Bills/Utilities</option>
                                    <option value="other">Other</option>
                                </select>
                                <button type="submit" class="md:col-span-4 bg-warning text-white p-3 rounded-lg font-semibold hover:bg-warning/80 transition duration-200 flex items-center justify-center space-x-2">
                                    <i class="fas fa-credit-card"></i><span>Track Expense</span>
                                </button>
                            </form>
                        </div>
                        
                        <div class="bg-white p-6 rounded-xl shadow-lg transition-colors duration-300">
                            <h3 class="text-xl font-bold text-primary mb-4 flex items-center space-x-2"><i class="fas fa-history"></i><span>Recent Activity (Last 5)</span></h3>
                            <div id="recentExpenseList" class="space-y-3 max-h-80 overflow-y-auto">
                                <p class="text-gray-500 text-center py-4">No recent expenses recorded.</p>
                            </div>
                        </div>
                    </div>

                    <div id="insightsContent" class="content-panel space-y-6 hidden">
                        <h2 class="text-3xl font-bold text-dark transition-colors duration-300">Detailed Financial Insights</h2>
                        
                        <div class="bg-white p-6 rounded-xl shadow-lg transition-colors duration-300">
                            <h3 class="chart-title text-xl font-bold text-primary mb-4 text-center">Expense Breakdown by Category</h3>
                            <div class="p-4" id="chartWrapper">
                                <canvas id="expenseChart" style="max-height: 400px;"></canvas>
                                <p id="chartPlaceholder" class="text-center text-gray-500 hidden py-8">Add expenses to see your spending chart!</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="insightsSummary">
                            <div class="bg-white p-4 rounded-xl shadow-lg text-center border-b-4 border-warning">
                                <p class="text-gray-700 text-sm">Total Spent</p>
                                <p class="text-2xl font-bold text-dark mt-1" id="totalSpent">₹0.00</p>
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-lg text-center border-b-4 border-primary">
                                <p class="text-gray-700 text-sm">Shopping</p>
                                <p class="text-2xl font-bold text-primary mt-1" id="shoppingTotal">₹0.00</p>
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-lg text-center border-b-4 border-success">
                                <p class="text-gray-700 text-sm">Food</p>
                                <p class="text-2xl font-bold text-success mt-1" id="foodTotal">₹0.00</p>
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-lg text-center border-b-4 border-danger">
                                <p class="text-gray-700 text-sm">Bills</p>
                                <p class="text-2xl font-bold text-danger mt-1" id="billsTotal">₹0.00</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="achievementsContent" class="content-panel space-y-6 hidden">
                        <h2 class="text-3xl font-bold text-dark transition-colors duration-300">Your Financial Milestones</h2>
                        
                        <div class="bg-white p-6 rounded-xl shadow-lg space-y-4">
                            <h3 class="text-xl font-bold text-primary mb-4">Current Goals Progress</h3>
                            
                            <div class="flex items-center space-x-4 border-b pb-3 border-gray-200">
                                <i class="fas fa-piggy-bank text-3xl text-green-500"></i>
                                <div class="flex-1">
                                    <p class="font-semibold">Savings Starter</p>
                                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                                        <div class="bg-green-600 h-2.5 rounded-full" style="width: 0%" id="savingsProgress"></div>
                                    </div>
                                </div>
                                <span class="text-sm text-gray-600" id="savingsStatus">0% Saved</span>
                            </div>

                            <div class="flex items-center space-x-4 border-b pb-3 border-gray-200">
                                <i class="fas fa-lock text-3xl text-indigo-500"></i>
                                <div class="flex-1">
                                    <p class="font-semibold">No Debt Streak</p>
                                    <p class="text-sm text-gray-600" id="debtStatus">Status: Positive Balance</p>
                                </div>
                                <i class="fas fa-check-circle text-2xl text-gray-400" id="debtIcon"></i>
                            </div>

                            <div class="flex items-center space-x-4">
                                <i class="fas fa-medal text-3xl text-yellow-500"></i>
                                <div class="flex-1">
                                    <p class="font-semibold">Expense Tracker Pro</p>
                                    <p class="text-sm text-gray-600" id="trackerStatus">Tracked 0 Expenses</p>
                                </div>
                                <i class="fas fa-star text-2xl text-gray-400" id="trackerIcon"></i>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold text-primary mb-4">Set Custom Milestones</h3>
                            <form id="addMilestoneForm" class="space-y-3">
                                <input type="text" id="milestoneName" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="e.g., Buy a New Laptop">
                                <div class="flex space-x-2">
                                    <input type="number" id="milestoneTarget" class="flex-1 p-3 border border-gray-300 rounded-lg" placeholder="Target Amount (₹)" min="1" step="0.01" required>
                                    <button type="submit" class="bg-success text-white p-3 rounded-lg font-semibold hover:bg-success/80 transition duration-200">Add Goal</button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold text-primary mb-4">Upcoming Milestones</h3>
                            <ul class="space-y-3" id="milestonesList">
                                <p class="text-gray-500 text-center py-4">No custom milestones set.</p>
                            </ul>
                        </div>
                    </div>

                    <div id="profileContent" class="content-panel space-y-6 hidden">
                        <h2 class="text-3xl font-bold text-dark transition-colors duration-300">User Profile</h2>
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold text-primary mb-4">Account Information</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between border-b pb-2">
                                    <span class="font-medium text-gray-700">Username:</span>
                                    <span id="profileUsername" class="font-semibold"></span>
                                </div>
                                <div class="flex justify-between border-b pb-2">
                                    <span class="font-medium text-gray-700">Password:</span>
                                    <span class="font-semibold text-danger">**********</span>
                                </div>
                                <div class="flex justify-between border-b pb-2">
                                    <span class="font-medium text-gray-700">AI Key Status:</span>
                                    <span id="aiKeyStatus" class="font-semibold text-green-500"></span>
                                </div>
                                <button id="resetAppBtn" class="w-full mt-4 bg-danger text-white p-3 rounded-lg font-semibold hover:bg-danger/80 transition duration-200">
                                    <i class="fas fa-trash"></i> Reset App (Clear All Data & Logout)
                                </button>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <div class="chatbot-container fixed bottom-5 right-5 z-40">
            <button class="chatbot-btn w-16 h-16 rounded-full bg-primary text-white text-2xl shadow-xl hover:bg-secondary transition duration-200 flex items-center justify-center" id="chatbotToggleBtn">
                <i class="fas fa-robot"></i>
            </button>
            <div class="chatbot-window absolute bottom-20 right-0 w-80 h-96 bg-white rounded-xl shadow-2xl flex flex-col overflow-hidden hidden" id="chatbotWindow">
                <div class="chatbot-header bg-primary text-white p-3 font-bold text-center">Finity AI Advisor</div>
                <div class="chatbot-messages flex-1 p-3 overflow-y-auto space-y-2" id="chatbotMessages">
                    <div class="message bot-message self-start bg-gray-100 text-gray-700 p-3 rounded-xl rounded-tl-none max-w-[85%]">Hello! I can analyze your local spending and give saving advice. Ask me anything!</div>
                </div>
                <div class="chatbot-input flex p-3 border-t border-gray-200">
                    <input type="text" id="chatbotInput" placeholder="Ask a financial question..." class="flex-1 p-2 border border-gray-300 rounded-l-lg text-sm focus:outline-none focus:ring-1 focus:ring-primary">
                    <button id="chatbotSendBtn" class="bg-primary text-white p-2 rounded-r-lg hover:bg-secondary transition duration-200 disabled:opacity-50" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

    </div>

    <div id="incomeModal" class="modal fixed inset-0 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold text-primary mb-4">Add Income</h3>
            <form id="incomeForm">
                <div class="mb-4">
                    <label for="incomeAmount" class="block text-gray-700 font-medium mb-2">Amount (₹)</label>
                    <input type="number" id="incomeAmount" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition-colors duration-300" placeholder="Enter amount" min="0.01" step="0.01" required>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="closeIncomeModal" class="bg-gray-300 text-dark p-3 rounded-lg font-semibold hover:bg-gray-400 transition duration-200">Cancel</button>
                    <button type="submit" class="bg-success text-white p-3 rounded-lg font-semibold hover:bg-success/80 transition duration-200">Add Income</button>
                </div>
            </form>
        </div>
    </div>
    
    <footer class="w-full bg-dark p-6 text-light mt-auto transition-colors duration-300">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center md:items-start space-y-4 md:space-y-0">
            <div class="text-center md:text-left">
                <div class="text-xl font-bold text-primary mb-2 flex items-center justify-center md:justify-start">
                    <i class="fas fa-wallet mr-2"></i> Finity
                </div>
                <p class="text-sm text-gray-400">AI-Powered Finance, Simplified.</p>
            </div>
            
            <div class="space-y-2 text-center md:text-right">
                <h4 class="font-semibold text-white">Contact & Support</h4>
                <div class="text-sm text-gray-400 flex items-center justify-center md:justify-end">
                    <i class="fas fa-phone mr-2 text-primary"></i> Phone: 
                    <span class="ml-2 font-mono" contenteditable="true">
                        [+1 234 567 8900]
                    </span>
                </div>
                <div class="text-sm text-gray-400 flex items-center justify-center md:justify-end">
                    <i class="fas fa-envelope mr-2 text-primary"></i> Email: 
                    <span class="ml-2 font-mono" contenteditable="true">
                        [support@finity.pro]
                    </span>
                </div>
            </div>
        </div>
    </footer>


    <script>
        const STORAGE_KEY = 'finity_prototype_data';
        const AI_KEY_STORAGE_KEY = 'finity_gemini_api_key';
        const MILESTONE_STORAGE_KEY = 'finity_milestones'; // New key for milestones
        const GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025';
        let currentUser = null;
        let aiApiKey = 'AIzaSyAwsQqMPAkp3VFjVKAdrXHOLkUsYcwgNBI'; // DEFAULT KEY SET HERE
        let expenseChartInstance = null;
        let initialBalance = 0;

        // --- 1. LOCAL DATA MANAGEMENT ---
        const loadData = () => JSON.parse(localStorage.getItem(STORAGE_KEY)) || { users: {}, expenses: [] };
        const saveData = (data) => localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        
        // New Milestone Data Management
        const loadMilestones = () => JSON.parse(localStorage.getItem(MILESTONE_STORAGE_KEY)) || {};
        const saveMilestones = (milestones) => localStorage.setItem(MILESTONE_STORAGE_KEY, JSON.stringify(milestones));

        // --- 2. UI UTILITIES ---
        const getElement = (id) => document.getElementById(id);

        const switchView = (viewId) => {
            const views = ['authPage', 'dashboardPage'];
            views.forEach(id => getElement(id).classList.add('hidden'));
            getElement(viewId).classList.remove('hidden');
        };

        const updateNavState = (targetId) => {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('text-gray-700', 'hover:bg-gray-100');
            });
            const activeBtn = document.querySelector(`.nav-btn[data-target="${targetId}"]`);
            if (activeBtn) {
                activeBtn.classList.add('bg-primary', 'text-white');
                activeBtn.classList.remove('text-gray-700', 'hover:bg-gray-100');
            }
            document.querySelectorAll('.content-panel').forEach(panel => panel.classList.add('hidden'));
            getElement(targetId).classList.remove('hidden');
        };
        
        // Notification Alert Function
        const showNotification = (message, type = 'success', duration = 3000) => {
            const container = getElement('notificationContainer');
            const alert = document.createElement('div');
            
            let bgColor = 'bg-green-500';
            let icon = 'fa-check-circle';
            
            if (type === 'warning') {
                bgColor = 'bg-yellow-500';
                icon = 'fa-exclamation-triangle';
            } else if (type === 'danger') {
                bgColor = 'bg-danger';
                icon = 'fa-times-circle';
            }

            alert.className = `notification-alert ${bgColor} text-white flex items-center space-x-3 opacity-0 translate-x-full`;
            alert.innerHTML = `<i class="fas ${icon} text-lg"></i><span>${message}</span>`;
            
            container.appendChild(alert);

            // Animate in
            setTimeout(() => {
                alert.classList.remove('opacity-0', 'translate-x-full');
                alert.classList.add('opacity-100', 'translate-x-0');
            }, 10);

            // Animate out and remove
            setTimeout(() => {
                alert.classList.remove('opacity-100', 'translate-x-0');
                alert.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => alert.remove(), 300);
            }, duration);
        };

        // --- 3. AUTHENTICATION (LOCAL STORAGE) ---
        let isRegisterMode = false;

        const handleAuth = (e) => {
            e.preventDefault();
            const username = getElement('authUsername').value.trim();
            const password = getElement('authPassword').value;
            const data = loadData();
            
            if (isRegisterMode) {
                // Register
                if (data.users[username]) {
                    showNotification('Username already exists!', 'danger');
                    return;
                }
                if (!localStorage.getItem(AI_KEY_STORAGE_KEY)) {
                    localStorage.setItem(AI_KEY_STORAGE_KEY, aiApiKey);
                }
                
                // Added totalSaved for the new feature
                data.users[username] = { password, balance: 0, initialBalance: 0, totalSaved: 0, joined: new Date().toISOString() };
                saveData(data);
                showNotification('Registration successful! Please log in.', 'success');
                isRegisterMode = false;
                updateAuthForm();
            } else {
                // Login
                const user = data.users[username];
                if (user && user.password === password) {
                    currentUser = { username, ...user };
                    localStorage.setItem('current_user', username);
                    switchView('dashboardPage');
                    updateDashboardUI();
                    updateNavState('dashContent');
                } else {
                    showNotification('Invalid username or password.', 'danger');
                }
            }
        };

        const updateAuthForm = () => {
            getElement('authTitle').textContent = isRegisterMode ? 'Sign Up to Finity' : 'Login to Finity';
            getElement('authBtnText').textContent = isRegisterMode ? 'Register' : 'Login';
            getElement('toggleAuthMode').textContent = isRegisterMode ? 'Already have an account? Login' : 'New User? Sign Up';
            getElement('authForm').reset();
        };

        const checkLogin = () => {
            const username = localStorage.getItem('current_user');
            if (username) {
                const data = loadData();
                const user = data.users[username];
                if (user) {
                    currentUser = { username, ...user };
                    // Ensure new properties exist for current user
                    if (currentUser.initialBalance === undefined) currentUser.initialBalance = currentUser.balance;
                    if (currentUser.totalSaved === undefined) currentUser.totalSaved = 0;
                    
                    // Update the local data structure in storage if a property was missing
                    const mustSave = currentUser.initialBalance === undefined || currentUser.totalSaved === undefined;
                    if (mustSave) {
                        data.users[username] = currentUser;
                        saveData(data);
                    }

                    initialBalance = currentUser.initialBalance;
                    switchView('dashboardPage');
                    return true;
                }
            }
            switchView('authPage');
            return false;
        };
        
        // --- 4. DASHBOARD & EXPENSE/INCOME/SAVING LOGIC ---
        
        const updateDashboardUI = () => {
            if (!currentUser) return;
            getElement('welcomeUsername').textContent = currentUser.username;
            getElement('currentBalanceDisplay').textContent = `Balance: ₹${currentUser.balance.toFixed(2)}`;
            // Update the new Saved display
            getElement('totalSavedDisplay').textContent = `Saved: ₹${currentUser.totalSaved.toFixed(2)}`;
            renderExpenses();
            updateAchievements();
            updateProfileSection();
        };

        const checkSpendingNotification = (oldBalance, newBalance) => {
            if (initialBalance === 0) return;
            
            const oldSpent = initialBalance - oldBalance;
            const newSpent = initialBalance - newBalance;
            
            // Check for every 10% spent mark
            for (let i = 1; i <= 9; i++) {
                const spendingMark = initialBalance * (i / 10);
                
                // Check if the old spent amount was below the mark and the new spent amount is above or at the mark
                if (newSpent > 0 && oldSpent < spendingMark && newSpent >= spendingMark) {
                    const percent = i * 10;
                    showNotification(`Heads up! You have now spent ${percent}% (₹${newSpent.toFixed(2)}) of your initial balance (₹${initialBalance.toFixed(2)}).`, 'warning');
                    break;
                }
            }
        };

        const addExpense = (e) => {
            e.preventDefault();
            const description = getElement('expenseDescription').value.trim();
            const amount = parseFloat(getElement('expenseAmount').value);
            const category = getElement('expenseCategory').value;

            if (amount <= 0 || isNaN(amount)) {
                showNotification('Please enter a valid expense amount.', 'danger');
                return;
            }
            
            if (currentUser.balance < amount) {
                showNotification(`Insufficient balance! Current Balance: ₹${currentUser.balance.toFixed(2)}`, 'danger');
                return;
            }

            const data = loadData();
            const oldBalance = currentUser.balance;

            const newExpense = {
                username: currentUser.username,
                description,
                amount: -amount, // Store as negative for consistency (expense)
                category,
                date: new Date().toISOString()
            };
            
            // Update user balance and save
            currentUser.balance -= amount;
            data.users[currentUser.username].balance = currentUser.balance;
            data.expenses.push(newExpense);
            saveData(data);
            
            checkSpendingNotification(oldBalance, currentUser.balance);
            showNotification(`Expense tracked: ₹${amount.toFixed(2)} for ${category}.`, 'warning');
            updateDashboardUI();
            updateInsightsUI();
            getElement('expenseForm').reset();
        };

        const addIncome = (e) => {
            e.preventDefault();
            const amount = parseFloat(getElement('incomeAmount').value);

            if (amount <= 0 || isNaN(amount)) {
                showNotification('Please enter a valid income amount.', 'danger');
                return;
            }

            const data = loadData();
            
            currentUser.balance += amount;
            
            // Update initialBalance only if it's the very first income
            if (initialBalance === 0) {
                initialBalance = currentUser.balance;
                currentUser.initialBalance = initialBalance;
            }

            data.users[currentUser.username].balance = currentUser.balance;
            data.users[currentUser.username].initialBalance = currentUser.initialBalance;
            
            const newIncome = {
                username: currentUser.username,
                description: 'Income',
                amount: amount, // Store as positive (income)
                category: 'income',
                date: new Date().toISOString()
            };
            data.expenses.push(newIncome);
            saveData(data);
            
            showNotification(`Income added: + ₹${amount.toFixed(2)}!`, 'success');
            updateDashboardUI();
            updateInsightsUI();
            getElement('incomeModal').classList.add('hidden');
            getElement('incomeForm').reset();
        };
        
        // Handle Save Money (Move Balance -> Saved)
        const handleSaveMoney = (e) => {
            e.preventDefault();
            const amount = parseFloat(getElement('saveAmount').value);

            if (amount <= 0 || isNaN(amount)) {
                showNotification('Please enter a valid amount to save.', 'danger');
                return;
            }
            
            if (currentUser.balance < amount) {
                showNotification(`Insufficient balance! Current Balance: ₹${currentUser.balance.toFixed(2)}`, 'danger');
                return;
            }

            const data = loadData();
            
            // Deduct from balance and add to saved total
            currentUser.balance -= amount;
            currentUser.totalSaved += amount;

            data.users[currentUser.username].balance = currentUser.balance;
            data.users[currentUser.username].totalSaved = currentUser.totalSaved;
            
            // Log as a transaction for completeness
            const newSaving = {
                username: currentUser.username,
                description: 'Savings Goal (Move out)',
                amount: -amount, 
                category: 'savings_out',
                date: new Date().toISOString()
            };
            data.expenses.push(newSaving);
            saveData(data);
            
            showNotification(`Saved ₹${amount.toFixed(2)} to your goals!`, 'primary');
            updateDashboardUI();
            updateAchievements(); 
            getElement('saveMoneyForm').reset();
        };

        // NEW: Handle Withdraw Money (Move Saved -> Balance)
        const handleWithdrawMoney = (e) => {
            e.preventDefault();
            const amount = parseFloat(getElement('withdrawAmount').value);

            if (amount <= 0 || isNaN(amount)) {
                showNotification('Please enter a valid amount to withdraw.', 'danger');
                return;
            }
            
            if (currentUser.totalSaved < amount) {
                showNotification(`Insufficient saved money! Current Saved: ₹${currentUser.totalSaved.toFixed(2)}`, 'danger');
                return;
            }

            const data = loadData();
            
            // Deduct from saved total and add to main balance
            currentUser.totalSaved -= amount;
            currentUser.balance += amount;

            data.users[currentUser.username].balance = currentUser.balance;
            data.users[currentUser.username].totalSaved = currentUser.totalSaved;
            
            // Log as a transaction for completeness (positive amount, special category)
            const newWithdrawal = {
                username: currentUser.username,
                description: 'Savings Withdrawal (Move in)',
                amount: amount, 
                category: 'savings_in',
                date: new Date().toISOString()
            };
            data.expenses.push(newWithdrawal);
            saveData(data);
            
            showNotification(`Withdrew ₹${amount.toFixed(2)} from savings to balance.`, 'success');
            updateDashboardUI();
            getElement('withdrawMoneyForm').reset();
        };


        const renderExpenses = () => {
            const listEl = getElement('recentExpenseList');
            const data = loadData();
            const userActivity = data.expenses
                // Filter to only include actual expenses, incomes, or savings transactions
                .filter(exp => exp.username === currentUser.username) 
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);

            listEl.innerHTML = '';

            if (userActivity.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500 text-center py-4">No recent activity recorded.</p>';
                return;
            }

            userActivity.forEach(exp => {
                const categoryColor = { 
                    'shopping': 'border-warning', 
                    'food': 'border-success', 
                    'bills': 'border-danger', 
                    'other': 'border-gray-500', 
                    'savings_out': 'border-primary', // Savings logged
                    'savings_in': 'border-success', // Withdrawal
                    'income': 'border-success' // Income
                }[exp.category];
                
                let textColor = 'text-danger';
                let prefixIcon = '<i class="fas fa-credit-card text-lg"></i>';
                let descriptionText = exp.description || exp.category.charAt(0).toUpperCase() + exp.category.slice(1);
                let displayAmount = Math.abs(exp.amount).toFixed(2);
                let amountSign = '-';

                if (exp.category === 'income' || exp.category === 'savings_in') {
                    textColor = 'text-success';
                    amountSign = '+';
                    prefixIcon = exp.category === 'income' ? '<i class="fas fa-coins text-lg"></i>' : '<i class="fas fa-undo text-lg"></i>';
                    descriptionText = exp.category === 'savings_in' ? 'Withdraw Savings' : descriptionText;
                } else if (exp.category === 'savings_out') {
                     textColor = 'text-primary';
                     prefixIcon = '<i class="fas fa-arrow-right-to-bracket text-lg"></i>';
                     descriptionText = 'Log Savings';
                }
                
                const isDarkMode = document.body.classList.contains('dark-mode');
                const bgColor = isDarkMode ? 'bg-[#222222]' : 'bg-gray-50'; 

                item.className = `expense-item flex justify-between items-center p-3 rounded-lg ${bgColor} border-l-4 ${categoryColor} shadow-sm transition-colors duration-300`;
                
                item.innerHTML = `
                    <div class="flex items-center space-x-2">
                        ${prefixIcon}
                        <div>
                            <strong class="text-dark">${descriptionText}</strong>
                            <p class="text-xs text-gray-500">${new Date(exp.date).toLocaleDateString()}</p>
                        </div>
                    </div>
                    <span class="text-lg font-bold ${textColor}">${amountSign} ₹${displayAmount}</span>
                `;
                listEl.appendChild(item);
            });
        };

        // --- 5. INSIGHTS LOGIC (Chart.js) ---

        const getExpenseSummary = () => {
            const data = loadData();
            // Filter to only include actual *expenses* (negative amounts and not 'income', 'savings_out', or 'savings_in' category)
            const userExpenses = data.expenses.filter(exp => exp.username === currentUser.username && exp.amount < 0 && exp.category !== 'income' && exp.category !== 'savings_out');
            const summary = { total: 0, shopping: 0, food: 0, bills: 0, other: 0 };
            
            userExpenses.forEach(exp => {
                const amount = Math.abs(exp.amount); // Use absolute amount for total spent
                summary.total += amount;
                if (summary[exp.category] !== undefined) {
                    summary[exp.category] += amount;
                } else {
                    summary.other += amount;
                }
            });
            return summary;
        };

        const updateInsightsUI = () => {
            const summary = getExpenseSummary();

            getElement('totalSpent').textContent = `₹${summary.total.toFixed(2)}`;
            getElement('shoppingTotal').textContent = `₹${summary.shopping.toFixed(2)}`;
            getElement('foodTotal').textContent = `₹${summary.food.toFixed(2)}`;
            getElement('billsTotal').textContent = `₹${summary.bills.toFixed(2)}`;
            // The 'other' total is not explicitly in the summary cards, but is part of the chart

            if (summary.total === 0) {
                if (expenseChartInstance) expenseChartInstance.destroy();
                getElement('expenseChart').classList.add('hidden');
                getElement('chartPlaceholder').classList.remove('hidden');
                return;
            }

            getElement('expenseChart').classList.remove('hidden');
            getElement('chartPlaceholder').classList.add('hidden');
            
            const categories = ['shopping', 'food', 'bills', 'other'];
            const dataValues = categories.map(c => summary[c]);
            const labels = categories.map(c => c.charAt(0).toUpperCase() + c.slice(1));
            const colors = ['#f8961e', '#4cc9f0', '#f72585', '#6c757d'];

            const ctx = getElement('expenseChart').getContext('2d');
            if (expenseChartInstance) expenseChartInstance.destroy();
            
            const chartFontColor = document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333';

            expenseChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataValues,
                        backgroundColor: colors,
                        hoverOffset: 16
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'top', 
                            labels: { color: chartFontColor } 
                        },
                        title: { display: false }
                    }
                }
            });
        };

        // --- 6. ACHIEVEMENTS LOGIC ---

        const updateAchievements = () => {
            const data = loadData();
            const userExpenses = data.expenses.filter(exp => exp.username === currentUser.username && exp.category !== 'income' && exp.category !== 'savings_out' && exp.category !== 'savings_in');
            const totalSpent = getExpenseSummary().total;
            
            // 1. Savings Starter (Goal: Save 5% of initialBalance, if initialBalance > 0)
            const targetSavings = initialBalance * 0.05; // 5% of the initial income
            const currentSavings = currentUser.totalSaved; // Use new totalSaved property

            let progress = 0;
            if (targetSavings > 0) {
                progress = Math.min(100, Math.max(0, (currentSavings / targetSavings) * 100));
            }

            getElement('savingsProgress').style.width = `${progress.toFixed(0)}%`;
            getElement('savingsStatus').textContent = `₹${currentSavings.toFixed(2)} / ₹${targetSavings.toFixed(2)} (${progress.toFixed(0)}%)`;
            if (progress >= 100) {
                getElement('savingsProgress').classList.remove('bg-green-600');
                getElement('savingsProgress').classList.add('bg-blue-600');
            } else {
                getElement('savingsProgress').classList.add('bg-green-600');
                getElement('savingsProgress').classList.remove('bg-blue-600');
            }

            // 2. Expense Tracker Pro
            const expenseCount = userExpenses.length;
            getElement('trackerStatus').textContent = `Tracked ${expenseCount} Expenses`;
            if (expenseCount >= 10) {
                getElement('trackerIcon').classList.remove('text-gray-400');
                getElement('trackerIcon').classList.add('text-yellow-500');
            } else {
                getElement('trackerIcon').classList.remove('text-yellow-500');
                getElement('trackerIcon').classList.add('text-gray-400');
            }
            
            // 3. No Debt Streak
            const debtStatusText = currentUser.balance >= 0 ? "Positive Balance" : "Debt Detected!";
            getElement('debtStatus').textContent = `Status: ${debtStatusText}`;
            if (currentUser.balance >= 0) {
                getElement('debtIcon').classList.remove('text-gray-400', 'text-danger');
                getElement('debtIcon').classList.add('text-green-500');
            } else {
                getElement('debtIcon').classList.remove('text-gray-400', 'text-green-500');
                getElement('debtIcon').classList.add('text-danger');
            }
            
            renderMilestones();
        };
        
        // New: Milestone Logic
        const addMilestone = (e) => {
            e.preventDefault();
            const name = getElement('milestoneName').value.trim();
            const target = parseFloat(getElement('milestoneTarget').value);
            
            if (!name || target <= 0 || isNaN(target)) {
                showNotification('Please enter a valid name and target amount.', 'danger');
                return;
            }
            
            const milestones = loadMilestones();
            if (!milestones[currentUser.username]) milestones[currentUser.username] = [];
            
            const newMilestone = {
                id: Date.now(), // Unique ID
                name,
                target,
                achieved: false
            };
            
            milestones[currentUser.username].push(newMilestone);
            saveMilestones(milestones);
            showNotification(`Milestone "${name}" added!`, 'success');
            getElement('addMilestoneForm').reset();
            renderMilestones();
        };

        const renderMilestones = () => {
            const listEl = getElement('milestonesList');
            const allMilestones = loadMilestones();
            const userMilestones = allMilestones[currentUser.username] || [];

            listEl.innerHTML = '';

            if (userMilestones.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500 text-center py-4">No custom milestones set.</p>';
                return;
            }
            
            const currentSaved = currentUser.totalSaved;
            const isDarkMode = document.body.classList.contains('dark-mode');

            userMilestones.forEach(milestone => {
                const progress = Math.min(100, Math.max(0, (currentSaved / milestone.target) * 100));
                const statusColor = milestone.achieved ? 'text-blue-600' : 'text-gray-400';
                const statusIcon = milestone.achieved ? 'fa-check-double' : 'fa-arrow-right';
                // Use a darker background for milestones in dark mode
                const bgColor = isDarkMode ? 'bg-[#222222]' : 'bg-gray-50';

                const item = document.createElement('li');
                item.className = `p-3 border border-gray-100 rounded-lg ${bgColor} flex justify-between items-center transition-colors duration-300`;
                item.innerHTML = `
                    <div class="flex-1">
                        <span class="font-semibold text-dark">${milestone.name}</span>
                        <p class="text-sm text-gray-500">Goal: ₹${milestone.target.toFixed(2)} - Progress: ${progress.toFixed(0)}%</p>
                    </div>
                    <i class="fas ${statusIcon} text-lg ${statusColor}"></i>
                    <button data-id="${milestone.id}" class="remove-milestone ml-3 text-danger hover:text-danger/80 transition duration-200"><i class="fas fa-times-circle"></i></button>
                `;
                listEl.appendChild(item);
                
                // Check for automatic achievement and update
                if (currentSaved >= milestone.target && !milestone.achieved) {
                    milestone.achieved = true;
                    showNotification(`Milestone Achieved: ${milestone.name}!`, 'success');
                    // Save the updated status
                    allMilestones[currentUser.username] = userMilestones;
                    saveMilestones(allMilestones);
                    // Re-render to show the updated icon
                    renderMilestones();
                }
            });
            
            // Attach listener for removal
            document.querySelectorAll('.remove-milestone').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idToRemove = parseInt(e.currentTarget.getAttribute('data-id'));
                    const milestones = loadMilestones();
                    milestones[currentUser.username] = milestones[currentUser.username].filter(m => m.id !== idToRemove);
                    saveMilestones(milestones);
                    showNotification('Milestone removed.', 'danger');
                    renderMilestones();
                });
            });
        };


        // --- 7. PROFILE LOGIC ---
        const updateProfileSection = () => {
            getElement('profileUsername').textContent = currentUser.username;
            const keyStatusEl = getElement('aiKeyStatus');
            
            keyStatusEl.textContent = 'Active (Default Key)';
            keyStatusEl.classList.remove('text-danger');
            keyStatusEl.classList.add('text-green-500');
            getElement('chatbotSendBtn').disabled = false;
        };

        // --- 8. GEMINI CHATBOT LOGIC (Uses new totalSaved for context) ---

        const appendMessage = (message, isUser = false) => {
            const messageDiv = document.createElement('div');
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            messageDiv.className = `message p-3 rounded-xl max-w-[85%] ${isUser ? 'self-end bg-primary text-white rounded-tr-none' : 'self-start rounded-tl-none'} ${isDarkMode && !isUser ? 'bg-dark-card text-light' : 'bg-gray-100 text-gray-700'}`;
            messageDiv.textContent = message;
            getElement('chatbotMessages').appendChild(messageDiv);
            getElement('chatbotMessages').scrollTop = getElement('chatbotMessages').scrollHeight;
            
            // Dark mode adjustment for bot messages after creation
            if (!isUser && isDarkMode) {
                 messageDiv.classList.remove('bg-gray-100', 'text-gray-700');
                 messageDiv.classList.add('bg-dark-card', 'text-light');
            }
        };

        const handleChatMessage = async () => {
            const message = getElement('chatbotInput').value.trim();
            if (!message || !aiApiKey) return;

            appendMessage(message, true);
            getElement('chatbotInput').value = '';
            
            const sendBtn = getElement('chatbotSendBtn');
            sendBtn.disabled = true;

            const typingIndicator = document.createElement('div');
            const isDarkMode = document.body.classList.contains('dark-mode');
            // Use a dark color for contrast in the typing indicator
            const typingClasses = isDarkMode ? 'bg-[#222222] text-light' : 'bg-gray-100 text-gray-700';

            typingIndicator.className = `message bot-message self-start p-3 rounded-xl rounded-tl-none max-w-[85%] flex items-center space-x-2 ${typingClasses}`;
            typingIndicator.innerHTML = `Thinking... <div class="loading !w-3 !h-3 !border-gray-500 !border-t-primary"></div>`;
            getElement('chatbotMessages').appendChild(typingIndicator);
            getElement('chatbotMessages').scrollTop = getElement('chatbotMessages').scrollHeight;
            
            try {
                const summary = getExpenseSummary();
                // Pass new totalSaved property to the AI for better context
                const prompt = `Act as a helpful financial advisor. The user is asking: "${message}". Their current financial summary is: Balance: ₹${currentUser.balance.toFixed(2)}, Initial Balance: ₹${initialBalance.toFixed(2)}, Total Saved: ₹${currentUser.totalSaved.toFixed(2)}, Total Spent: ₹${summary.total.toFixed(2)}, Shopping: ₹${summary.shopping.toFixed(2)}, Food: ₹${summary.food.toFixed(2)}, Bills: ₹${summary.bills.toFixed(2)}, Other: ₹${summary.other.toFixed(2)}. Based on this data, answer their question and provide specific, actionable advice on spending less and saving more. Keep the tone friendly and encouraging.`;

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${aiApiKey}`;
                
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: { parts: [{ text: "You are a friendly and encouraging financial advisor who gives actionable, personalized advice." }] },
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const botResponse = result.candidates?.[0]?.content?.parts?.[0]?.text || 'Sorry, I could not process that. Please check your API key.';
                
                getElement('chatbotMessages').removeChild(typingIndicator);
                appendMessage(botResponse, false);
            } catch (error) {
                console.error("Gemini API Error:", error);
                getElement('chatbotMessages').removeChild(typingIndicator);
                appendMessage("An unexpected network error occurred. Please verify your Gemini API key.", false);
            } finally {
                sendBtn.disabled = false;
            }
        };
        
        // --- 9. INITIALIZATION & EVENT LISTENERS ---

        document.addEventListener('DOMContentLoaded', () => {
            
            // Change the body class for the new layout structure
            document.body.classList.remove('p-4', 'md:p-8');
            document.body.classList.add('p-0', 'md:p-0', 'min-h-screen', 'flex', 'flex-col');
            
            if (checkLogin()) {
                updateDashboardUI();
                updateInsightsUI();
                updateNavState('dashContent');
            }
            
            // Event Listeners for Auth
            getElement('authForm').addEventListener('submit', handleAuth);
            getElement('toggleAuthMode').addEventListener('click', (e) => {
                e.preventDefault();
                isRegisterMode = !isRegisterMode;
                updateAuthForm();
            });
            getElement('logoutBtn').addEventListener('click', () => {
                localStorage.removeItem('current_user');
                currentUser = null;
                switchView('authPage');
            });
            
            // Event Listeners for Dashboard
            getElement('expenseForm').addEventListener('submit', addExpense);
            
            // New: Save Money Listener (Move Balance -> Saved)
            getElement('saveMoneyForm').addEventListener('submit', handleSaveMoney);
            
            // NEW: Withdraw Money Listener (Move Saved -> Balance)
            getElement('withdrawMoneyForm').addEventListener('submit', handleWithdrawMoney);
            
            // Income Modal Listeners
            getElement('addIncomeBtn').addEventListener('click', () => {
                getElement('incomeModal').classList.remove('hidden');
                document.getElementById('incomeAmount').focus();
            });
            getElement('closeIncomeModal').addEventListener('click', () => {
                getElement('incomeModal').classList.add('hidden');
            });
            getElement('incomeForm').addEventListener('submit', addIncome);
            
            // Navigation Listeners
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const targetId = e.currentTarget.getAttribute('data-target');
                    updateNavState(targetId);
                    if (targetId === 'insightsContent') updateInsightsUI();
                    if (targetId === 'achievementsContent') updateAchievements();
                });
            });

            // Dark Mode Toggle
            getElement('toggleDarkMode').addEventListener('click', () => {
                const isDarkMode = getElement('body').classList.toggle('dark-mode');
                
                // Redraw chart to update colors for dark mode
                if (expenseChartInstance) updateInsightsUI();

                // Recolor all existing bot messages and expense items
                const botMessages = document.querySelectorAll('.chatbot-messages .message:not(.self-end)');
                botMessages.forEach(msg => {
                    if (isDarkMode) {
                        msg.classList.remove('bg-gray-100', 'text-gray-700');
                        msg.classList.add('bg-dark-card', 'text-light');
                    } else {
                        msg.classList.add('bg-gray-100', 'text-gray-700');
                        msg.classList.remove('bg-dark-card', 'text-light');
                    }
                });
                
                // Recolor expense items and milestones on dashboard
                renderExpenses();
                renderMilestones();
            });
            
            // AI Chatbot Listeners
            getElement('chatbotToggleBtn').addEventListener('click', () => {
                getElement('chatbotWindow').classList.toggle('hidden');
                if (!getElement('chatbotWindow').classList.contains('hidden')) {
                    getElement('chatbotMessages').scrollTop = getElement('chatbotMessages').scrollHeight;
                }
            });

            getElement('chatbotSendBtn').addEventListener('click', handleChatMessage);
            getElement('chatbotInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleChatMessage();
            });
            
            // New: Milestone Listener
            getElement('addMilestoneForm').addEventListener('submit', addMilestone);

            // Reset App Button
            getElement('resetAppBtn').addEventListener('click', () => {
                if (confirm('Are you sure you want to completely reset the application? All user data, expenses, goals, and the AI key will be permanently deleted.')) {
                    localStorage.removeItem(STORAGE_KEY);
                    localStorage.removeItem(AI_KEY_STORAGE_KEY);
                    localStorage.removeItem(MILESTONE_STORAGE_KEY); // Remove milestones too
                    localStorage.removeItem('current_user');
                    currentUser = null;
                    aiApiKey = '';
                    showNotification('Application data successfully reset. Reloading...', 'danger');
                    setTimeout(() => window.location.reload(), 1000);
                }
            });
        });
    </script>
</body>
</html>
