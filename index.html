<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finity - Local Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4361ee',
                        'secondary': '#3f37c9',
                        'success': '#4cc9f0',
                        'danger': '#f72585',
                        'warning': '#f8961e',
                        'dark': '#1d3557',
                        'light': '#f8f9fa',
                        'gray': '#6c757d',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-image: url('https://i.imgur.com/your-image-url.jpg'); /* REPLACE with the actual image URL */
            background-size: cover;
            background-position: center;
            background-attachment: fixed; /* Keeps background fixed when scrolling */
            position: relative; /* Needed for pseudo-element overlay */
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth dark mode transition */
            overflow-y: scroll; /* Ensure scrollbar if content exceeds viewport */
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.7); /* Light overlay for readability */
            backdrop-filter: blur(8px); /* Blur effect on the background */
            z-index: -1; /* Place behind content */
            transition: background-color 0.3s ease;
        }

        .dark-mode body::before {
            background-color: rgba(0, 0, 0, 0.7); /* Darker overlay for dark mode */
        }
        
        /* Dark mode styles */
        .dark-mode {
            color: #e2e8f0;
        }
        .dark-mode .bg-white { background-color: #2d3748 !important; }
        .dark-mode input, .dark-mode select { background-color: #1a202c !important; color: #e2e8f0; border-color: #4a5568; }
        .dark-mode .text-gray-700 { color: #a0aec0; }
        .dark-mode .border-gray-200 { border-color: #4a5568; }
        .dark-mode .message.bot-message { background-color: #1a202c; color: #e2e8f0; }
        .dark-mode .expense-item { background-color: #1a202c !important; }
        .dark-mode .nav-btn.text-gray-700 { color: #a0aec0 !important; }
        .dark-mode .nav-btn:hover { background-color: #1a202c !important; }
        .dark-mode .chart-title { color: #e2e8f0 !important; }
        
        .loading {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .modal { background: rgba(0, 0, 0, 0.5); z-index: 50; }
    </style>
</head>
<body class="p-4 md:p-8 transition-colors duration-300" id="body">
    
    <div class="max-w-6xl mx-auto relative z-10"> <!-- Added relative z-10 to ensure content is above the overlay --><!-- AI API KEY MODAL - REMOVED --><!-- AUTHENTICATION PAGE (Simplified) --><div class="flex flex-col min-h-screen items-center justify-center" id="authPage">
            <div class="text-center mb-10">
                <i class="fas fa-wallet text-6xl text-primary mb-4"></i>
                <h1 class="text-5xl font-extrabold text-dark transition-colors duration-300">FINITY</h1>
                <p class="text-gray-700 mt-2 transition-colors duration-300">AI-Powered Finance Manager Prototype</p>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-sm transition-colors duration-300">
                <h2 class="text-2xl font-bold text-center text-primary mb-6" id="authTitle">Login</h2>
                <form id="authForm">
                    <div class="mb-4">
                        <label for="authUsername" class="block text-gray-700 font-medium mb-2">Username</label>
                        <input type="text" id="authUsername" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition-colors duration-300" placeholder="Enter username" required>
                    </div>
                    <div class="mb-6">
                        <label for="authPassword" class="block text-gray-700 font-medium mb-2">Password</label>
                        <input type="password" id="authPassword" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition-colors duration-300" placeholder="Enter password" required>
                    </div>
                    <!-- Initial Balance Input (Visible only during registration) -->
                    <div class="mb-4 hidden" id="initialBalanceGroup">
                        <label for="initialBalance" class="block text-gray-700 font-medium mb-2">Initial Balance (₹)</label>
                        <input type="number" id="initialBalance" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition-colors duration-300" placeholder="e.g., 20000" min="0" step="0.01" required>
                    </div>
                    <button type="submit" class="w-full bg-primary text-white p-3 rounded-lg font-semibold hover:bg-secondary transition duration-200">
                        <span id="authBtnText">Login</span>
                    </button>
                </form>
                <div class="text-center mt-4">
                    <a href="#" id="toggleAuthMode" class="text-primary hover:underline text-sm font-medium">New User? Sign Up</a>
                </div>
            </div>
        </div>

        <!-- DASHBOARD PAGE --><div class="hidden" id="dashboardPage">
            <!-- Header --><header class="bg-white p-4 md:p-6 rounded-xl shadow-lg mb-6 flex justify-between items-center transition-colors duration-300">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-wallet text-3xl text-primary"></i>
                    <h1 class="text-2xl font-bold text-dark transition-colors duration-300">Finity</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm font-semibold p-2 bg-success text-white rounded-full px-4" id="currentBalanceDisplay">
                        Balance: ₹0.00
                    </div>
                    <button id="logoutBtn" class="text-gray-700 hover:text-danger p-2 rounded-full transition duration-200">
                        <i class="fas fa-sign-out-alt text-xl"></i>
                    </button>
                    <button id="toggleDarkMode" class="text-gray-700 hover:text-primary p-2 rounded-full transition duration-200">
                        <i class="fas fa-moon text-xl"></i>
                    </button>
                </div>
            </header>

            <!-- Main Content Area (Tabs/Sections) --><div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Sidebar Navigation --><nav class="lg:col-span-1 bg-white p-4 rounded-xl shadow-lg transition-colors duration-300 h-fit sticky top-6">
                    <h3 class="text-lg font-bold text-primary mb-4 pb-2 border-b border-gray-200">Menu</h3>
                    <ul class="space-y-2">
                        <li><button class="nav-btn w-full text-left p-3 rounded-lg flex items-center space-x-3 bg-primary text-white" data-target="dashContent"><i class="fas fa-chart-line"></i><span>Dashboard</span></button></li>
                        <li><button class="nav-btn w-full text-left p-3 rounded-lg flex items-center space-x-3 text-gray-700 hover:bg-gray-100" data-target="insightsContent"><i class="fas fa-chart-pie"></i><span>Insights</span></button></li>
                        <li><button class="nav-btn w-full text-left p-3 rounded-lg flex items-center space-x-3 text-gray-700 hover:bg-gray-100" data-target="achievementsContent"><i class="fas fa-trophy"></i><span>Achievements</span></button></li>
                        <li><button class="nav-btn w-full text-left p-3 rounded-lg flex items-center space-x-3 text-gray-700 hover:bg-gray-100" data-target="profileContent"><i class="fas fa-user"></i><span>Profile</span></button></li>
                    </ul>
                </nav>

                <!-- Content Panels --><main class="lg:col-span-3">
                    <!-- Dashboard Content --><div id="dashContent" class="content-panel space-y-6">
                        <h2 class="text-3xl font-bold text-dark transition-colors duration-300">Welcome, <span id="welcomeUsername">User</span>!</h2>
                        
                        <!-- Expense Form --><div class="bg-white p-6 rounded-xl shadow-lg transition-colors duration-300">
                            <h3 class="text-xl font-bold text-primary mb-4 flex items-center space-x-2"><i class="fas fa-plus-circle"></i><span>Add New Expense</span></h3>
                            <form id="expenseForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <input type="text" id="expenseDescription" class="md:col-span-2 p-3 border border-gray-300 rounded-lg" placeholder="Description (e.g., Coffee, Rent share)">
                                <input type="number" id="expenseAmount" class="p-3 border border-gray-300 rounded-lg" placeholder="Amount (₹)" min="0.01" step="0.01" required>
                                <select id="expenseCategory" class="p-3 border border-gray-300 rounded-lg" required>
                                    <option value="shopping">Shopping</option>
                                    <option value="food">Food</option>
                                    <option value="bills">Bills/Utilities</option>
                                    <option value="other">Other</option>
                                </select>
                                <button type="submit" class="md:col-span-4 bg-warning text-white p-3 rounded-lg font-semibold hover:bg-warning/80 transition duration-200 flex items-center justify-center space-x-2">
                                    <i class="fas fa-credit-card"></i><span>Track Expense</span>
                                </button>
                            </form>
                        </div>
                        
                        <!-- Recent Activity --><div class="bg-white p-6 rounded-xl shadow-lg transition-colors duration-300">
                            <h3 class="text-xl font-bold text-primary mb-4 flex items-center space-x-2"><i class="fas fa-history"></i><span>Recent Activity (Last 5)</span></h3>
                            <div id="recentExpenseList" class="space-y-3 max-h-80 overflow-y-auto">
                                <!-- Expenses will be inserted here --><p class="text-gray-500 text-center py-4">No recent expenses recorded.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Insights Content --><div id="insightsContent" class="content-panel space-y-6 hidden">
                        <h2 class="text-3xl font-bold text-dark transition-colors duration-300">Detailed Financial Insights</h2>
                        
                        <!-- Chart Area --><div class="bg-white p-6 rounded-xl shadow-lg transition-colors duration-300">
                            <h3 class="chart-title text-xl font-bold text-primary mb-4 text-center">Expense Breakdown by Category</h3>
                            <div class="p-4" id="chartWrapper">
                                <canvas id="expenseChart" style="max-height: 400px;"></canvas>
                                <p id="chartPlaceholder" class="text-center text-gray-500 hidden py-8">Add expenses to see your spending chart!</p>
                            </div>
                        </div>

                        <!-- Summary Cards --><div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="insightsSummary">
                            <div class="bg-white p-4 rounded-xl shadow-lg text-center border-b-4 border-warning">
                                <p class="text-gray-700 text-sm">Total Spent</p>
                                <p class="text-2xl font-bold text-dark mt-1" id="totalSpent">₹0.00</p>
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-lg text-center border-b-4 border-primary">
                                <p class="text-gray-700 text-sm">Shopping</p>
                                <p class="text-2xl font-bold text-primary mt-1" id="shoppingTotal">₹0.00</p>
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-lg text-center border-b-4 border-success">
                                <p class="text-gray-700 text-sm">Food</p>
                                <p class="text-2xl font-bold text-success mt-1" id="foodTotal">₹0.00</p>
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-lg text-center border-b-4 border-danger">
                                <p class="text-gray-700 text-sm">Bills</p>
                                <p class="text-2xl font-bold text-danger mt-1" id="billsTotal">₹0.00</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Achievements Content --><div id="achievementsContent" class="content-panel space-y-6 hidden">
                        <h2 class="text-3xl font-bold text-dark transition-colors duration-300">Your Financial Milestones</h2>
                        
                        <div class="bg-white p-6 rounded-xl shadow-lg space-y-4">
                            <h3 class="text-xl font-bold text-primary mb-4">Current Goals Progress</h3>
                            
                            <div class="flex items-center space-x-4 border-b pb-3 border-gray-200">
                                <i class="fas fa-piggy-bank text-3xl text-green-500"></i>
                                <div class="flex-1">
                                    <p class="font-semibold">Savings Starter</p>
                                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                                        <div class="bg-green-600 h-2.5 rounded-full" style="width: 0%" id="savingsProgress"></div>
                                    </div>
                                </div>
                                <span class="text-sm text-gray-600" id="savingsStatus">0% Saved</span>
                            </div>

                            <div class="flex items-center space-x-4 border-b pb-3 border-gray-200">
                                <i class="fas fa-lock text-3xl text-indigo-500"></i>
                                <div class="flex-1">
                                    <p class="font-semibold">No Debt Streak</p>
                                    <p class="text-sm text-gray-600" id="debtStatus">Streak: 0 Days</p>
                                </div>
                                <i class="fas fa-check-circle text-2xl text-gray-400" id="debtIcon"></i>
                            </div>

                            <div class="flex items-center space-x-4">
                                <i class="fas fa-medal text-3xl text-yellow-500"></i>
                                <div class="flex-1">
                                    <p class="font-semibold">Expense Tracker Pro</p>
                                    <p class="text-sm text-gray-600" id="trackerStatus">Tracked 0 Expenses</p>
                                </div>
                                <i class="fas fa-star text-2xl text-gray-400" id="trackerIcon"></i>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold text-primary mb-4">Upcoming Milestones</h3>
                            <ul class="space-y-3">
                                <li class="p-3 border border-gray-100 rounded-lg bg-gray-50 flex justify-between items-center">
                                    <span>First ₹10,000 Saved</span>
                                    <i class="fas fa-arrow-right text-gray-400"></i>
                                </li>
                                <li class="p-3 border border-gray-100 rounded-lg bg-gray-50 flex justify-between items-center">
                                    <span>Balanced Budget Master (4 categories tracked)</span>
                                    <i class="fas fa-arrow-right text-gray-400"></i>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Profile Content --><div id="profileContent" class="content-panel space-y-6 hidden">
                        <h2 class="text-3xl font-bold text-dark transition-colors duration-300">User Profile</h2>
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold text-primary mb-4">Account Information</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between border-b pb-2">
                                    <span class="font-medium text-gray-700">Username:</span>
                                    <span id="profileUsername" class="font-semibold"></span>
                                </div>
                                <div class="flex justify-between border-b pb-2">
                                    <span class="font-medium text-gray-700">Password:</span>
                                    <span class="font-semibold text-danger">**********</span>
                                </div>
                                <div class="flex justify-between border-b pb-2">
                                    <span class="font-medium text-gray-700">AI Key Status:</span>
                                    <span id="aiKeyStatus" class="font-semibold text-green-500"></span>
                                </div>
                                <div class="flex justify-between border-b pb-2">
                                    <span class="font-medium text-gray-700">Initial Balance:</span>
                                    <span id="profileInitialBalance" class="font-semibold"></span>
                                </div>
                                <div class="flex justify-between border-b pb-2">
                                    <span class="font-medium text-gray-700">Current Balance:</span>
                                    <span id="profileCurrentBalance" class="font-semibold"></span>
                                </div>
                                <div class="flex justify-between border-b pb-2">
                                    <span class="font-medium text-gray-700">Total Expenses:</span>
                                    <span id="profileTotalExpenses" class="font-semibold"></span>
                                </div>
                                <!-- Add Balance Button -->
                                <button id="addBalanceBtn" class="w-full mt-2 bg-success text-white p-3 rounded-lg font-semibold hover:bg-success/80 transition duration-200 flex items-center justify-center space-x-2">
                                    <i class="fas fa-plus-circle"></i><span>Add Balance</span>
                                </button>
                                <button id="resetAppBtn" class="w-full mt-4 bg-danger text-white p-3 rounded-lg font-semibold hover:bg-danger/80 transition duration-200">
                                    <i class="fas fa-trash"></i> Reset App (Clear All Data & Logout)
                                </button>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <!-- Chatbot Container --><div class="chatbot-container fixed bottom-5 right-5 z-40">
            <button class="chatbot-btn w-16 h-16 rounded-full bg-primary text-white text-2xl shadow-xl hover:bg-secondary transition duration-200 flex items-center justify-center" id="chatbotToggleBtn">
                <i class="fas fa-robot"></i>
            </button>
            <div class="chatbot-window absolute bottom-20 right-0 w-80 h-96 bg-white rounded-xl shadow-2xl flex flex-col overflow-hidden hidden" id="chatbotWindow">
                <div class="chatbot-header bg-primary text-white p-3 font-bold text-center">Finity AI Advisor</div>
                <div class="chatbot-messages flex-1 p-3 overflow-y-auto space-y-2" id="chatbotMessages">
                    <div class="message bot-message self-start bg-gray-100 text-gray-700 p-3 rounded-xl rounded-tl-none max-w-[85%]">Hello! I can analyze your local spending and give saving advice. Ask me anything!</div>
                </div>
                <div class="chatbot-input flex p-3 border-t border-gray-200">
                    <input type="text" id="chatbotInput" placeholder="Ask a financial question..." class="flex-1 p-2 border border-gray-300 rounded-l-lg text-sm focus:outline-none focus:ring-1 focus:ring-primary">
                    <button id="chatbotSendBtn" class="bg-primary text-white p-2 rounded-r-lg hover:bg-secondary transition duration-200 disabled:opacity-50" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const STORAGE_KEY = 'finity_prototype_data';
        const AI_KEY_STORAGE_KEY = 'finity_gemini_api_key';
        const GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025';
        let currentUser = null;
        let aiApiKey = 'AIzaSyAwsQqMPAkp3VFjVKAdrXHOLkUsYcwgNBI'; // DEFAULT KEY SET HERE
        let expenseChartInstance = null;
        
        // --- 1. LOCAL DATA MANAGEMENT ---
        const loadData = () => JSON.parse(localStorage.getItem(STORAGE_KEY)) || { users: {}, expenses: [] };
        const saveData = (data) => localStorage.setItem(STORAGE_KEY, JSON.stringify(data));

        // --- 2. UI UTILITIES ---
        const getElement = (id) => document.getElementById(id);

        const switchView = (viewId) => {
            const views = ['authPage', 'dashboardPage'];
            views.forEach(id => getElement(id).classList.add('hidden'));
            getElement(viewId).classList.remove('hidden');
        };

        const updateNavState = (targetId) => {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('text-gray-700', 'hover:bg-gray-100');
            });
            const activeBtn = document.querySelector(`.nav-btn[data-target="${targetId}"]`);
            if (activeBtn) {
                activeBtn.classList.add('bg-primary', 'text-white');
                activeBtn.classList.remove('text-gray-700', 'hover:bg-gray-100');
            }
            document.querySelectorAll('.content-panel').forEach(panel => panel.classList.add('hidden'));
            getElement(targetId).classList.remove('hidden');
        };
        
        // --- 3. AUTHENTICATION (LOCAL STORAGE) ---
        let isRegisterMode = false;

        const handleAuth = (e) => {
            e.preventDefault();
            const username = getElement('authUsername').value.trim();
            const password = getElement('authPassword').value;
            const data = loadData();
            
            if (isRegisterMode) {
                const initialBalance = parseFloat(getElement('initialBalance').value);
                if (isNaN(initialBalance) || initialBalance < 0) {
                    alert('Please enter a valid initial balance (>= 0).');
                    return;
                }
                
                // Register
                if (data.users[username]) {
                    alert('Username already exists!');
                    return;
                }
                // Store the default API key if not already stored (ensures chatbot is always enabled if the user logs in fresh)
                if (!localStorage.getItem(AI_KEY_STORAGE_KEY)) {
                    localStorage.setItem(AI_KEY_STORAGE_KEY, aiApiKey);
                }
                
                data.users[username] = { password, balance: initialBalance, initialBalance: initialBalance, joined: new Date().toISOString() }; // Store initial balance
                saveData(data);
                alert('Registration successful! Please log in.');
                isRegisterMode = false;
                updateAuthForm();
            } else {
                // Login
                const user = data.users[username];
                if (user && user.password === password) {
                    currentUser = { username, ...user };
                    localStorage.setItem('current_user', username);
                    switchView('dashboardPage');
                    updateDashboardUI();
                    updateNavState('dashContent');
                } else {
                    alert('Invalid username or password.');
                }
            }
        };

        const updateAuthForm = () => {
            getElement('authTitle').textContent = isRegisterMode ? 'Sign Up' : 'Login';
            getElement('authBtnText').textContent = isRegisterMode ? 'Register' : 'Login';
            getElement('toggleAuthMode').textContent = isRegisterMode ? 'Already have an account? Login' : 'New User? Sign Up';
            // Show/hide initial balance field
            getElement('initialBalanceGroup').classList.toggle('hidden', !isRegisterMode);
            getElement('authForm').reset();
        };

        const checkLogin = () => {
            const username = localStorage.getItem('current_user');
            if (username) {
                const data = loadData();
                const user = data.users[username];
                if (user) {
                    currentUser = { username, ...user };
                    switchView('dashboardPage');
                    return true;
                }
            }
            switchView('authPage');
            return false;
        };
        
        // --- 4. DASHBOARD & EXPENSE LOGIC ---
        
        const updateDashboardUI = () => {
            if (!currentUser) return;
            getElement('welcomeUsername').textContent = currentUser.username;
            getElement('currentBalanceDisplay').textContent = `Balance: ₹${currentUser.balance.toFixed(2)}`;
            renderExpenses();
            updateAchievements();
            updateProfileSection();
        };

        const addExpense = (e) => {
            e.preventDefault();
            const description = getElement('expenseDescription').value.trim();
            const amount = parseFloat(getElement('expenseAmount').value);
            const category = getElement('expenseCategory').value;

            if (amount <= 0 || isNaN(amount)) {
                alert('Please enter a valid amount.');
                return;
            }
            if (amount > currentUser.balance) {
                alert('Insufficient balance! Current Balance: ' + currentUser.balance.toFixed(2));
                return;
            }

            const data = loadData();
            const newExpense = {
                username: currentUser.username,
                description,
                amount,
                category,
                date: new Date().toISOString()
            };
            
            // Update user balance and save
            currentUser.balance -= amount;
            data.users[currentUser.username].balance = currentUser.balance;
            data.expenses.push(newExpense);
            saveData(data);
            
            updateDashboardUI();
            updateInsightsUI();
            getElement('expenseForm').reset();
        };

        const renderExpenses = () => {
            const listEl = getElement('recentExpenseList');
            const data = loadData();
            const userExpenses = data.expenses
                .filter(exp => exp.username === currentUser.username)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);

            listEl.innerHTML = '';

            if (userExpenses.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500 text-center py-4">No recent expenses recorded.</p>';
                return;
            }

            userExpenses.forEach(exp => {
                const categoryColor = { 'shopping': 'border-warning', 'food': 'border-success', 'bills': 'border-danger', 'other': 'border-gray-500' }[exp.category];
                const item = document.createElement('div');
                item.className = `expense-item flex justify-between items-center p-3 rounded-lg bg-gray-50 border-l-4 ${categoryColor} shadow-sm transition-colors duration-300`;
                item.innerHTML = `
                    <div>
                        <strong class="text-dark">${exp.description || exp.category.toUpperCase()}</strong>
                        <p class="text-xs text-gray-500">${new Date(exp.date).toLocaleDateString()}</p>
                    </div>
                    <span class="text-lg font-bold text-danger">- ₹${exp.amount.toFixed(2)}</span>
                `;
                listEl.appendChild(item);
            });
        };

        // --- 5. INSIGHTS LOGIC (Chart.js) ---

        const getExpenseSummary = () => {
            const data = loadData();
            const userExpenses = data.expenses.filter(exp => exp.username === currentUser.username);
            const summary = { total: 0, shopping: 0, food: 0, bills: 0, other: 0 };
            
            userExpenses.forEach(exp => {
                summary.total += exp.amount;
                summary[exp.category] += exp.amount;
            });
            return summary;
        };

        const updateInsightsUI = () => {
            const summary = getExpenseSummary();

            getElement('totalSpent').textContent = `₹${summary.total.toFixed(2)}`;
            getElement('shoppingTotal').textContent = `₹${summary.shopping.toFixed(2)}`;
            getElement('foodTotal').textContent = `₹${summary.food.toFixed(2)}`;
            getElement('billsTotal').textContent = `₹${summary.bills.toFixed(2)}`;

            if (summary.total === 0) {
                if (expenseChartInstance) expenseChartInstance.destroy();
                getElement('expenseChart').classList.add('hidden');
                getElement('chartPlaceholder').classList.remove('hidden');
                return;
            }

            getElement('expenseChart').classList.remove('hidden');
            getElement('chartPlaceholder').classList.add('hidden');
            
            const categories = ['shopping', 'food', 'bills', 'other'];
            const dataValues = categories.map(c => summary[c]);
            const labels = categories.map(c => c.charAt(0).toUpperCase() + c.slice(1));
            const colors = ['#f8961e', '#4cc9f0', '#f72585', '#6c757d'];

            const ctx = getElement('expenseChart').getContext('2d');
            if (expenseChartInstance) expenseChartInstance.destroy();

            expenseChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataValues,
                        backgroundColor: colors,
                        hoverOffset: 16
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333' } },
                        title: { display: false }
                    }
                }
            });
        };

        // --- 6. ACHIEVEMENTS LOGIC ---

        const updateAchievements = () => {
            const data = loadData();
            const userExpenses = data.expenses.filter(exp => exp.username === currentUser.username);
            const totalSpent = getExpenseSummary().total;
            
            // 1. Savings Starter (Goal: Save 5% of *initial* balance)
            const initialBalance = currentUser.initialBalance || 0; // Use stored initial balance
            const targetSavings = initialBalance * 0.05; // 5% of initial balance
            const currentSavings = initialBalance - totalSpent;
            const progress = initialBalance > 0 ? Math.min(100, Math.max(0, (currentSavings / targetSavings) * 100)) : 0;

            getElement('savingsProgress').style.width = `${progress.toFixed(0)}%`;
            getElement('savingsStatus').textContent = `${progress.toFixed(0)}% Saved`;

            // 2. Expense Tracker Pro
            const expenseCount = userExpenses.length;
            getElement('trackerStatus').textContent = `Tracked ${expenseCount} Expenses`;
            if (expenseCount >= 10) {
                getElement('trackerIcon').classList.remove('text-gray-400');
                getElement('trackerIcon').classList.add('text-yellow-500');
            } else {
                getElement('trackerIcon').classList.remove('text-yellow-500');
                getElement('trackerIcon').classList.add('text-gray-400');
            }
            
            // 3. Debt Streak (Placeholder logic for simplicity)
            // Since this is a simple finance tracker, we assume balance > 0 means no debt
            const debtStatusText = currentUser.balance > 0 ? "0 Days (Positive Balance)" : "Debt Detected!";
            getElement('debtStatus').textContent = debtStatusText;
            if (currentUser.balance > 0) {
                getElement('debtIcon').classList.remove('text-gray-400', 'text-danger');
                getElement('debtIcon').classList.add('text-green-500');
            } else {
                getElement('debtIcon').classList.remove('text-gray-400', 'text-green-500');
                getElement('debtIcon').classList.add('text-danger');
            }
        };

        // --- 7. PROFILE LOGIC ---
        const updateProfileSection = () => {
            getElement('profileUsername').textContent = currentUser.username;
            getElement('profileInitialBalance').textContent = `₹${(currentUser.initialBalance || 0).toFixed(2)}`;
            getElement('profileCurrentBalance').textContent = `₹${currentUser.balance.toFixed(2)}`;
            // Calculate total expenses for profile
            const data = loadData();
            const userExpenses = data.expenses.filter(exp => exp.username === currentUser.username);
            const totalExpenses = userExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            getElement('profileTotalExpenses').textContent = `₹${totalExpenses.toFixed(2)}`;

            const keyStatusEl = getElement('aiKeyStatus');
            
            // Since the key is set by default, the status is always active
            keyStatusEl.textContent = 'Active (Default Key)';
            keyStatusEl.classList.remove('text-danger');
            keyStatusEl.classList.add('text-green-500');
            getElement('chatbotSendBtn').disabled = false;
        };

        // --- Add Balance Modal Logic ---
        const addBalance = () => {
            const amountStr = prompt("Enter the amount to add to your balance:");
            if (amountStr === null) return; // User cancelled

            const amount = parseFloat(amountStr);
            if (isNaN(amount) || amount <= 0) {
                alert("Please enter a valid positive amount.");
                return;
            }

            const data = loadData();
            // Update user balance and save
            currentUser.balance += amount;
            data.users[currentUser.username].balance = currentUser.balance;
            saveData(data);

            updateDashboardUI();
            updateProfileSection(); // Update profile balance display
            alert(`₹${amount.toFixed(2)} added to your balance successfully!`);
        };

        // --- 8. GEMINI CHATBOT LOGIC ---

        const appendMessage = (message, isUser = false) => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message p-3 rounded-xl max-w-[85%] ${isUser ? 'self-end bg-primary text-white rounded-tr-none' : 'self-start bg-gray-100 text-gray-700 rounded-tl-none'}`;
            messageDiv.textContent = message;
            getElement('chatbotMessages').appendChild(messageDiv);
            getElement('chatbotMessages').scrollTop = getElement('chatbotMessages').scrollHeight;
        };

        const handleChatMessage = async () => {
            const message = getElement('chatbotInput').value.trim();
            if (!message || !aiApiKey) return;

            appendMessage(message, true);
            getElement('chatbotInput').value = '';
            
            const sendBtn = getElement('chatbotSendBtn');
            sendBtn.disabled = true;

            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'message bot-message self-start p-3 bg-gray-100 text-gray-700 rounded-xl rounded-tl-none max-w-[85%] flex items-center space-x-2';
            typingIndicator.innerHTML = `Thinking... <div class="loading !w-3 !h-3 !border-gray-500 !border-t-primary"></div>`;
            getElement('chatbotMessages').appendChild(typingIndicator);
            getElement('chatbotMessages').scrollTop = getElement('chatbotMessages').scrollHeight;

            try {
                const summary = getExpenseSummary();
                const prompt = `Act as a helpful financial advisor. The user is asking: "${message}". Their current financial summary is: Balance: ₹${currentUser.balance.toFixed(2)}, Total Spent: ₹${summary.total.toFixed(2)}, Shopping: ₹${summary.shopping.toFixed(2)}, Food: ₹${summary.food.toFixed(2)}, Bills: ₹${summary.bills.toFixed(2)}, Other: ₹${summary.other.toFixed(2)}. Based on this data, answer their question and provide specific, actionable advice on spending less and saving more. Keep the tone friendly and encouraging.`;

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${aiApiKey}`;
                
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: { parts: [{ text: "You are a friendly and encouraging financial advisor who gives actionable, personalized advice." }] },
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const botResponse = result.candidates?.[0]?.content?.parts?.[0]?.text || 'Sorry, I could not process that. Please check your API key.';
                
                getElement('chatbotMessages').removeChild(typingIndicator);
                appendMessage(botResponse, false);
            } catch (error) {
                console.error("Gemini API Error:", error);
                getElement('chatbotMessages').removeChild(typingIndicator);
                appendMessage("An unexpected network error occurred. Please verify your Gemini API key.", false);
            } finally {
                sendBtn.disabled = false;
            }
        };
        
        // --- 9. INITIALIZATION & EVENT LISTENERS ---

        document.addEventListener('DOMContentLoaded', () => {
            // NOTE: The API Key Modal logic is removed as the key is set by default.
            
            // Load and check user session
            if (checkLogin()) {
                updateDashboardUI();
                updateInsightsUI();
                updateNavState('dashContent');
            }
            
            // Event Listeners for Auth
            getElement('authForm').addEventListener('submit', handleAuth);
            getElement('toggleAuthMode').addEventListener('click', (e) => {
                e.preventDefault();
                isRegisterMode = !isRegisterMode;
                updateAuthForm();
            });
            getElement('logoutBtn').addEventListener('click', () => {
                localStorage.removeItem('current_user');
                currentUser = null;
                switchView('authPage');
            });
            
            // Event Listeners for Dashboard
            getElement('expenseForm').addEventListener('submit', addExpense);
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const targetId = e.currentTarget.getAttribute('data-target');
                    updateNavState(targetId);
                    // Rerender specific pages on view change
                    if (targetId === 'insightsContent') updateInsightsUI();
                    if (targetId === 'achievementsContent') updateAchievements();
                });
            });

            // Dark Mode Toggle
            getElement('toggleDarkMode').addEventListener('click', () => {
                getElement('body').classList.toggle('dark-mode');
                // Redraw chart to update colors for dark mode
                if (expenseChartInstance) updateInsightsUI();
            });
            
            // Add Balance Button
            getElement('addBalanceBtn').addEventListener('click', addBalance);
            
            // AI Chatbot Listeners
            getElement('chatbotToggleBtn').addEventListener('click', () => {
                getElement('chatbotWindow').classList.toggle('hidden');
                // Scroll to bottom when opening
                if (!getElement('chatbotWindow').classList.contains('hidden')) {
                    getElement('chatbotMessages').scrollTop = getElement('chatbotMessages').scrollHeight;
                }
            });

            getElement('chatbotSendBtn').addEventListener('click', handleChatMessage);
            getElement('chatbotInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleChatMessage();
            });

            // Reset App Button
            getElement('resetAppBtn').addEventListener('click', () => {
                if (confirm('Are you sure you want to completely reset the application? All user data, expenses, and the AI key will be permanently deleted.')) {
                    localStorage.removeItem(STORAGE_KEY);
                    localStorage.removeItem(AI_KEY_STORAGE_KEY);
                    localStorage.removeItem('current_user');
                    currentUser = null;
                    aiApiKey = '';
                    alert('Application data successfully reset.');
                    window.location.reload(); 
                }
            });
        });
    </script>
</body>
</html>
